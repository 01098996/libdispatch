language: cpp
sudo: false

# Test matrix generated from scripts/gen_test_configs.py
matrix:
  include:
  - {compiler: gcc, env: DISPATCH_BUILD_TYPE=Debug DISPATCH_COMPILER=gcc}
  - {compiler: gcc, env: DISPATCH_BUILD_TYPE=Release DISPATCH_COMPILER=gcc}
  - {compiler: clang, env: DISPATCH_BUILD_TYPE=Release DISPATCH_COMPILER=clang}
  - {compiler: clang, env: DISPATCH_BUILD_TYPE=Debug DISPATCH_COMPILER=clang}
  - {compiler: clang, env: DISPATCH_BUILD_TYPE=Release DISPATCH_COMPILER=clang DISPATCH_ENABLE_TEST_SUITE=1}
  - {compiler: clang, env: DISPATCH_BUILD_TYPE=Debug DISPATCH_COMPILER=clang DISPATCH_ENABLE_TEST_SUITE=1}
  - {compiler: clang, env: 'DISPATCH_BUILD_TYPE=Release DISPATCH_COMPILER=clang DISPATCH_ENABLE_TEST_SUITE=1
      DISPATCH_SANITIZE=address,undefined'}

before_script:
- |
  if [[ "${DISPATCH_ENABLE_TEST_SUITE:-}" -eq 1 ]]; then
    export DISPATCH_TEST_PERMITTED_FAILURES=priority2,read2,apply
    export DISPATCH_TEST_RANDOM_SEED=$RANDOM
    if [[ "${DISPATCH_BUILD_TYPE:-}" == "Debug" ]]; then
      export LIBDISPATCH_LOG=0
    else
      export "LIBDISPATCH_LOG=${LIBDISPATCH_LOG:-stderr}"
    fi
  fi

script:
- mkdir travis-build && cd travis-build
- ../configure
- make install DESTDIR=$PWD/staging
- |
  if [[ "${DISPATCH_ENABLE_TEST_SUITE:-}" -eq 1 ]]; then
    make check
  fi
